{% extends 'blood/base.html' %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<style>
    /* üåü Dashboard Custom Styling */
    body {
        background: linear-gradient(135deg, #e8f0fe 0%, #ffffff 100%);
    }

    .dashboard-card {
        border: none;
        border-radius: 20px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    .card-header {
        border-radius: 20px 20px 0 0 !important;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .table thead {
        background: #f7f7f7;
    }

    .table-hover tbody tr:hover {
        background-color: #f0f8ff;
    }

    .btn-primary {
        background: linear-gradient(90deg, #007bff, #00bfff);
        border: none;
    }

    .btn-primary:hover {
        background: linear-gradient(90deg, #0056b3, #0077ff);
    }

    .rounded-circle {
        border: 3px solid #00bfff;
    }

    .badge {
        font-size: 0.9rem;
    }

    h2 {
        font-weight: 700;
        color: #003366;
    }
</style>

<h2 class="text-center mb-4">üëã Welcome, {{ request.user.username }}</h2>

<div class="row g-4">
    <!-- Profile Card -->
    <div class="col-lg-4">
        <div class="card dashboard-card">
            <div class="card-header bg-gradient bg-secondary text-white text-center">Your Profile</div>
            <div class="card-body text-center">
                {% if donor_profile %}
                    <div class="mb-3">
                        {% if donor_profile.profile_pic %}
                            <img src="{{ donor_profile.profile_pic.url }}" class="rounded-circle img-thumbnail" style="width:130px; height:130px; object-fit:cover;">
                        {% else %}
                            <img src="https://via.placeholder.com/130" class="rounded-circle img-thumbnail" style="width:130px; height:130px; object-fit:cover;">
                        {% endif %}
                    </div>

                    <div class="text-start ps-4">
                        <p><strong>ü©∏ Blood Group:</strong> {{ donor_profile.blood_group }}</p>
                        <p><strong>üìû Phone:</strong> {{ donor_profile.phone }}</p>
                        <p><strong>üè´ Department:</strong> {{ donor_profile.department }}</p>
                        <p>
                            <strong>‚ö° Available:</strong>
                            <input type="checkbox" id="availabilityToggle" {% if donor_profile.available %}checked{% endif %}>
                        </p>
                    </div>

                    <a href="{% url 'edit_profile' %}" class="btn btn-primary btn-sm mt-2 w-100">‚úèÔ∏è Edit Profile</a>
                {% else %}
                    <p>You don‚Äôt have a profile yet.</p>
                    <a href="{% url 'create_donor_profile' %}" class="btn btn-primary btn-sm">Create Profile</a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Available Donors -->
    <div class="col-lg-8">
        <div class="card dashboard-card">
            <div class="card-header bg-success text-white">üßç‚Äç‚ôÇÔ∏è Available Donors</div>
            <div class="card-body">
                {% if donors %}
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Blood Group</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for donor in donors %}
                        <tr>
                            <td>{{ donor.user.username }}</td>
                            <td><span class="badge bg-danger">{{ donor.blood_group }}</span></td>
                            <td>
                                {% if donor != donor_profile %}
                                    <a href="{% url 'request_donor' donor.id %}" class="btn btn-sm btn-outline-primary">Request</a>
                                {% else %}
                                    <span class="text-muted">Your Profile</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                    <p class="text-center text-muted">No donors available currently.</p>
                {% endif %}
            </div>
        </div>

        <!-- My Requests -->
        <div class="card dashboard-card mt-4">
            <div class="card-header bg-info text-white">üì© My Requests</div>
            <div class="card-body">
                {% if my_requests %}
                <table class="table table-striped align-middle">
                    <thead>
                        <tr>
                            <th>To</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for req in my_requests %}
                        <tr>
                            <td>{{ req.donor.user.username }}</td>
                            <td>
                                {% if req.status == 'Pending' %}
                                    <span class="badge bg-warning text-dark">Pending ‚è≥</span>
                                {% elif req.status == 'Approved' %}
                                    <span class="badge bg-success">Approved ‚úÖ</span>
                                {% else %}
                                    <span class="badge bg-danger">Declined ‚ùå</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                    <p class="text-center text-muted">You haven‚Äôt made any requests yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('availabilityToggle')?.addEventListener('change', function() {
    fetch("{% url 'toggle_availability' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(res => res.json())
    .then(data => {
        if(data.status === 'success'){
            alert("Availability: " + (data.available ? "üü¢ Active" : "üî¥ Inactive"));
        } else {
            alert("Error toggling availability");
        }
    });
});
</script>

{% endblock %}
